# Copilot Instructions

## Build, Test, Lint
- **Setup (full integration run):** `sudo ./setup.sh`
- **Teardown:** `sudo ./uninstall.sh` (add `--all` to remove installed tools)
- **Targeted checks (used in CI/README):**
  - Apache config validation: `sudo apachectl configtest`
  - Rebuild a site binary: `cd ~/Developer/sites/<name> && swift build -c release`
- **Swift package tests (submodules):**
  - Run all tests: `cd ~/Developer/tooling/<name> && swift test` (or `sites/<name>`)
  - Run a single suite/test (example from `tooling/orchestrator`): `swift test --filter "OrchestratorDaemon"` / `swift test --filter "OrchestratorDaemon — handleSiteChanges"`
- **CI reference:** `.github/workflows/test-setup.yml` runs `sudo -E ./setup.sh` and then verifies installed tools/configs.  
There is no separate lint or unit-test runner at the repo root.

## High-level Architecture
- This repo is a macOS dev environment manager. `setup.sh` installs dotfiles, tools, Apache config placeholder, cloudflared config, launchd agents, and the orchestrator daemon with a shared SQLite state DB at `~/Library/Application Support/com.mac9sb/state.db`.
- `sites/` and `tooling/` are Git submodules; submodule directories are the source of truth for what gets configured.
- Runtime is coordinated by the orchestrator LaunchDaemon, which scans `~/Developer/sites`, builds server binaries, generates Apache + cloudflared config, and supervises processes with health checks.
- Apache routing is generated by orchestrator and uses virtual hosts + path-based routing for local dev (`http://localhost/<site-name>/`). Cloudflare tunnel ingress is generated from `tooling/orchestrator/Sources/OrchestratorCLI/Resources/cloudflared/config.yml` and forwards to Apache on `:80`.

## Key Conventions
- **Site naming drives routing:**
  - Directory with a dot (e.g., `sites/cool-app.com/`) → custom domain.
  - Directory without a dot (e.g., `sites/api/`) → subdomain of the primary domain.
  - The primary domain is read from the `# primary-domain: ...` comment in `tooling/orchestrator/Sources/OrchestratorCLI/Resources/cloudflared/config.yml`.
- **Site classification:**
  - `.output/` present → static site.
  - `.build/release/<exec>` or `.build/<triple>/release/<exec>` present → server site.
  - Executable name comes from the first `.executableTarget` in `Package.swift`.
- **Shared state:** orchestrator uses a single SQLite DB (WAL mode) for atomic coordination.
- **Server restarts:** use `orchestrator restart <name>`.
- **Template rendering:** `render_template` replaces `{{KEY}}` placeholders via `sed` (used across setup and watcher scripts).
- **Submodules:** avoid `git -C sites/<name> pull`; use `git submodule update --remote --merge` to keep submodule tracking intact.
- **Agent submodules:** `tooling/agents/*` include their own `AGENTS.md` workflow/memory rules; follow them when working in that subtree.
