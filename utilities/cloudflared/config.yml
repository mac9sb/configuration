# =============================================================================
#  Cloudflare Tunnel Configuration
#  Managed by: ~/Developer (infra-as-repo)
#
#  This file is version-controlled and symlinked to ~/.cloudflared/config.yml
#  during setup. It contains no credentials — the credentials JSON (secret)
#  stays off-repo at ~/.cloudflared/maclong.json, created by the user with:
#    cloudflared tunnel create maclong --credentials-file ~/.cloudflared/maclong.json
#
#  If the tunnel already exists (e.g., from a previous install), fetch the
#  credentials file instead:
#    cloudflared tunnel token --cred-file ~/.cloudflared/maclong.json maclong
#
#  Primary domain (parsed by setup.sh / sites-watcher.sh):
#    Sites without a dot in their directory name become subdomains of this
#    domain (e.g. sites/api-thing/ → api-thing.maclong.dev). Sites whose
#    directory name contains a dot are treated as custom domains and get
#    auto-managed ingress entries below (e.g. sites/cool-app.com/).
#
# primary-domain: maclong.dev
#
#  Routing strategy:
#    All ingress rules forward traffic to Apache on :80. Apache handles
#    per-site routing through VirtualHost blocks generated by sites-watcher.sh.
#
#    Directory name        Apache VirtualHost        Ingress match
#    ─────────────────     ─────────────────────     ─────────────────
#    sites/maclong.dev/    ServerName maclong.dev     hostname: maclong.dev
#    sites/api-thing/      ServerName api-thing.      hostname: *.maclong.dev
#                            maclong.dev
#    sites/cool-app.com/   ServerName cool-app.com    hostname: cool-app.com
#
#  To add a new subdomain site:
#    1. git submodule add <url> sites/<name>    (no dot in name)
#    2. DNS is already covered by the *.maclong.dev wildcard
#    3. sites-watcher auto-generates the Apache VirtualHost
#
#  To add a custom domain site:
#    1. git submodule add <url> sites/example.com
#    2. sites-watcher auto-updates the ingress block below (do not edit it)
#    3. Route DNS to the tunnel:
#         cloudflared tunnel route dns maclong example.com
#    4. sites-watcher auto-generates the Apache VirtualHost
# =============================================================================

tunnel: maclong
credentials-file: /Users/mac/.cloudflared/maclong.json

# Metrics server for health monitoring (localhost only)
metrics: localhost:9090

# Graceful shutdown timeout
grace-period: 30s

# Retries on connection failures
retries: 5

# --- Ingress Rules -----------------------------------------------------------
#  Explicit entries for the primary domain and wildcard subdomains.
#  Custom domain sites are auto-added below by sites-watcher.
#  The catch-all at the end is required by cloudflared.

ingress:
  # Primary domain
  - hostname: maclong.dev
    service: http://localhost:80
  # Wildcard subdomains (covers all sites/*/  without a dot)
  - hostname: "*.maclong.dev"
    service: http://localhost:80
  # --- Custom domains (auto-generated by sites-watcher; do not edit) ---
  # sites-watcher:BEGIN
  # (none)
  # sites-watcher:END
  # Catch-all (required — handles any unmatched request)
  - service: http://localhost:80
