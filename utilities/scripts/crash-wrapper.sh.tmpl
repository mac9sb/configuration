#!/bin/sh
# Crash-guarded launcher for {{SITE_NAME}}
# Tracks consecutive crashes; notifies after {{MAX_RETRIES}} failures.

CRASH_FILE="{{CRASH_COUNT_FILE}}"
MAX_RETRIES={{MAX_RETRIES}}

# Read current crash count
if [ -f "$CRASH_FILE" ]; then
    COUNT=$(cat "$CRASH_FILE" 2>/dev/null || printf '0')
else
    COUNT=0
fi

# If we've exceeded max retries, notify and exit
if [ "$COUNT" -ge "$MAX_RETRIES" ]; then
    osascript -e 'display notification "{{SITE_NAME}} has crashed '"$COUNT"' times consecutively. Manual intervention required." with title "Server Crash Alert" subtitle "{{SITE_NAME}}" sound name "Basso"' 2>/dev/null || true
    printf "[%s] {{SITE_NAME}} exceeded max retries (%d). Stopping.\n" "$(date)" "$COUNT" >> "{{WATCHER_DIR}}/{{SITE_NAME}}.log"
    # Reset so a manual restart can try again
    printf '0' > "$CRASH_FILE"
    exit 1
fi

# Increment crash counter (will be reset to 0 on clean exit)
printf '%s' "$((COUNT + 1))" > "$CRASH_FILE"

# Run the binary
export PORT="{{PORT}}"
"{{BINARY_PATH}}" 2>&1

EXIT_CODE=$?
if [ "$EXIT_CODE" -eq 0 ]; then
    # Clean exit â€” reset counter
    printf '0' > "$CRASH_FILE"
fi

exit $EXIT_CODE
