#!/bin/sh
# Restart {{SITE_NAME}} server after binary update

printf "[%s] Binary updated, restarting {{SITE_NAME}}...\n" "$(date)" >> "{{WATCHER_DIR}}/{{SITE_NAME}}-watcher.log"

# Reset crash counter since this is a deliberate rebuild
printf '0' > "{{CRASH_COUNT_FILE}}"

# Small delay to ensure the binary write is complete
sleep 1

# Restart the server agent
launchctl kickstart -k "gui/{{UID_NUM}}/{{SERVER_LABEL}}" 2>/dev/null || {
    launchctl bootout "gui/{{UID_NUM}}/{{SERVER_LABEL}}" 2>/dev/null || true
    launchctl bootstrap "gui/{{UID_NUM}}" "{{SERVER_PLIST}}" 2>/dev/null || true
}

printf "[%s] {{SITE_NAME}} restarted successfully.\n" "$(date)" >> "{{WATCHER_DIR}}/{{SITE_NAME}}-watcher.log"
