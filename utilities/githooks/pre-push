#!/bin/sh

# ── Pre-push hook: Submodule hygiene ────────────────────────────────────────
# Ensures submodules are clean, staged, and not detached before allowing a push.
set -e
ERRORS=0

printf '\n\033[1;33m───────────────────────────────────────────────────────────────────────────────\033[0m\n'
printf '\033[1;33m  Pre-push hook: Submodule hygiene checks\033[0m\n'
printf '\033[1;33m───────────────────────────────────────────────────────────────────────────────\033[0m\n'

UTILITIES_DIR="${UTILITIES_DIR:-$HOME/Developer/utilities}"
UTILS="$UTILITIES_DIR/utils.sh"
if [ -f "$UTILS" ]; then
    . "$UTILS"
else
    echo "[ERROR] Utility script not found: $UTILS"
    exit 1
fi

# Run checks and report results (task prints status)
task "Check dirty submodules" check_dirty_submodules "return 0"
task "Check unstaged submodules" check_unstaged_submodules "return 0"
task "Check detached submodules" check_detached_submodules "return 0"

DIRTY=$(check_dirty_submodules)
UNSTAGED=$(check_unstaged_submodules)
DETACHED=$(check_detached_submodules)

# If any checks find problems, fail the push with actionable messages
if [ -n "$DIRTY" ]; then
    error "$(cat <<EOF
Dirty submodules with uncommitted changes:
$(printf '%s\n' "$DIRTY" | sed 's/^/  → /')
Commit or stash changes inside the submodule before pushing.
EOF
)"
    ERRORS=$((ERRORS + 1))
fi

if [ -n "$UNSTAGED" ]; then
    error "$(cat <<EOF
Submodule pointer changes not staged:
$(printf '%s\n' "$UNSTAGED" | sed 's/^/  → /')
The submodule was updated (e.g. via git -C) but the parent repo doesn't track the new commit yet. Run:
    git add <submodule-path> && git commit
Or use the correct submodule workflow:
    git submodule update --remote --merge
    git add <submodule-path> && git commit
EOF
)"
    ERRORS=$((ERRORS + 1))
fi

if [ -n "$DETACHED" ]; then
    warn "$(cat <<EOF
Submodules with mismatched detached HEAD:
$(printf '%s\n' "$DETACHED" | sed 's/^/  → /')
Stage the submodule pointer update:
    git add <submodule-path> && git commit
EOF
)"
    ERRORS=$((ERRORS + 1))
fi

UNINIT="$(git submodule status 2>/dev/null | grep '^-' | awk '{print $2}')"

if [ -n "$UNINIT" ]; then
    warn "$(cat <<EOF
Uninitialised submodules:
$(printf '%s\n' "$UNINIT" | sed 's/^/  → /')
Run: git submodule update --init --recursive
EOF
)"
fi

if [ "$ERRORS" -gt 0 ]; then
    error "$(cat <<EOF
Push blocked — fix $ERRORS submodule issue(s) above.
To bypass (not recommended): git push --no-verify
EOF
)"
    exit 1
fi

success "Submodule hygiene checks passed. Push allowed."
exit 0
